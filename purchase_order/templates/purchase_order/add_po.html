{% extends 'base.html' %}
{% block content %}
<style>
    /* Main Styles for Purchase Order Form */
    :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --success-color: #27ae60;
    --danger-color: #e74c3c;
    --light-gray: #f5f7fa;
    --border-color: #dfe4ea;
    --text-color: #2d3436;
    --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: var(--text-color);
    line-height: 1.6;
    }

    .container {
    max-width: 1200px;
    padding: 20px;
    }

    /* Headings */
    h1 {
    color: var(--primary-color);
    font-weight: 600;
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 10px;
    margin-bottom: 25px;
    }

    h2 {
    color: var(--primary-color);
    font-size: 1.5rem;
    margin-top: 20px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
    }

    /* Form Controls */
    .form-group {
    margin-bottom: 15px;
    }

    .form-control {
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px 12px;
    transition: border-color 0.2s ease;
    }

    .form-control:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-control[readonly] {
    background-color: var(--light-gray);
    cursor: not-allowed;
    }

    select.form-control {
    cursor: pointer;
    background-position: right 10px center;
    background-repeat: no-repeat;
    background-size: 12px;
    padding-right: 30px;
    }

    input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin-left: 10px;
    vertical-align: middle;
    }

    textarea.form-control {
    min-height: 80px;
    resize: vertical;
    }

    /* Tables */
    .table {
    width: 100%;
    margin-bottom: 1rem;
    background-color: transparent;
    border-collapse: collapse;
    box-shadow: var(--shadow);
    }

    .table thead th {
    background-color: var(--primary-color);
    color: white;
    font-weight: 500;
    text-align: left;
    padding: 12px;
    border: none;
    }

    .table tbody tr {
    background-color: white;
    transition: background-color 0.2s ease;
    }

    .table tbody tr:nth-child(even) {
    background-color: var(--light-gray);
    }

    .table tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.05);
    }

    .table td {
    padding: 12px;
    vertical-align: middle;
    border-top: 1px solid var(--border-color);
    }

    #cost-summary-table {
    margin-top: 20px;
    margin-bottom: 30px;
    }

    #cost-summary-table tfoot {
    font-weight: bold;
    }

    /* Buttons */
    .btn {
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    }

    .btn-primary {
    background-color: var(--secondary-color);
    color: white;
    }

    .btn-primary:hover {
    background-color: #2980b9;
    box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
    }

    .btn-secondary {
    background-color: #95a5a6;
    color: white;
    }

    .btn-secondary:hover {
    background-color: #7f8c8d;
    box-shadow: 0 2px 10px rgba(149, 165, 166, 0.3);
    }

    .btn-danger {
    background-color: var(--danger-color);
    color: white;
    }

    .btn-danger:hover {
    background-color: #c0392b;
    box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
    }

    /* Layout Enhancements */
    .row {
    margin-bottom: 20px;
    }

    .gap-2 {
    gap: 10px;
    }

    .mt-4 {
    margin-top: 25px;
    }

    .justify-content-end {
    justify-content: flex-end;
    }

    .d-flex {
    display: flex;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
    .col-md-6 {
        margin-bottom: 20px;
    }
    
    .table {
        display: block;
        overflow-x: auto;
    }
    
    .d-flex {
        flex-direction: column;
    }
    
    .gap-2 {
        gap: 8px;
    }
    
    .btn {
        width: 100%;
        margin-bottom: 8px;
    }
    }

    /* Card-like sections */
    .card-section {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    }

    /* PO Number highlight */
    #po-number {
    font-weight: bold;
    background-color: #ffeaa7;
    border: 1px solid #fdcb6e;
    }

    /* Total amount highlight */
    #total-amount {
    font-weight: bold;
    font-size: 1.1rem;
    background-color: #e6f7ff;
    border: 1px solid #91d5ff;
    }
</style>
<div class="container">
    <h1>New Purchase Order</h1>
    <div class="form-group">
        <label for="po-number">Purchase Order:</label>
        <input type="text" id="po-number" class="form-control" value="{{ next_po_number }}" readonly>
    </div>

    <div class="row">
        <!-- Supplier Details -->
        <div class="col-md-6">
            <h2>Supplier Details</h2>
            <div class="form-group">
                <label for="supplier-name">Name:</label>
                <select id="supplier-name" class="form-control">
                    <option value="">Select Supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.supplier_id }}">{{ supplier.supplier_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="supplier-address">Address:</label>
                <input type="text" id="supplier-address" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="supplier-city">City:</label>
                <input type="text" id="supplier-city" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="supplier-region">Region:</label>
                <input type="text" id="supplier-region" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="supplier-phone">Phone Number:</label>
                <input type="text" id="supplier-phone" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="supplier-payment-terms">Payment Terms:</label>
                <input type="text" id="supplier-payment-terms" class="form-control" readonly>
            </div>
        </div>

        <!-- Store Details -->
        <div class="col-md-6">
            <h2>Store Details</h2>
            <div class="form-group">
                <label for="my-store">My Store:</label>
                <input type="checkbox" id="my-store" {% if my_store %}checked{% endif %}>
            </div>
            <div class="form-group">
                <label for="store-name">Name:</label>
                <select id="store-name" class="form-control">
                    <option value="">Select Store</option>
                    {% for store in stores %}
                    <option value="{{ store.store_id }}">{{ store.store_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="store-address">Address:</label>
                <input type="text" id="store-address" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="store-city">City:</label>
                <input type="text" id="store-city" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="store-region">Region:</label>
                <input type="text" id="store-region" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="store-phone">Phone Number:</label>
                <input type="text" id="store-phone" class="form-control" readonly>
            </div>
        </div>
    </div>
    <!-- Order Details -->
    <div class="row">
        <div class="col-md-12">
            <h2>Order Details</h2>
            <div class="form-group">
                <label for="reference-number">Reference Number:</label>
                <input type="text" id="reference-number" class="form-control">
            </div>
            <div class="form-group">
                <label for="ordered-date">Ordered Date:</label>
                <input type="date" id="ordered-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="expected-delivery-date">Expected Delivery Date:</label>
                <input type="date" id="expected-delivery-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="shipped-by">Shipped By:</label>
                <select id="shipped-by" class="form-control">
                    <option value="None">None</option>
                    <option value="Supplier">Supplier</option>
                    <option value="Store">Store</option>
                    <option value="Others">Others</option>
                </select>
            </div>
            <div class="form-group">
                <label for="shipment-preference">Shipment Preference:</label>
                <select id="shipment-preference" class="form-control">
                    <option value="None">None</option>
                    <option value="Truck">Truck</option>
                    <option value="407">407</option>
                    <option value="Tata Ace">Tata Ace</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notes">Notes:</label>
                <textarea id="notes" class="form-control" rows="3"></textarea>
            </div>
        </div>
    </div>
    <!-- Product Details -->
    <div class="row">
        <div class="col-md-12">
            <h2>Product Details</h2>
            <table id="product-table" class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>UOM</th>
                        <th>Category</th>
                        <th>Quantity</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select class="form-control product-name" onchange="updateProductDetails(this)">
                                <option value="">Select Product</option>
                                {% for product in products %}
                                <option value="{{ product.product_id }}" data-description="{{ product.product_description }}" data-uom="{{ product.uom }}" data-category="{{ product.category_id.category_name }}">
                                    {{ product.product_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="text" class="form-control product-description" readonly></td>
                        <td><input type="text" class="form-control product-uom" readonly></td>
                        <td><input type="text" class="form-control product-category" readonly></td>
                        <td><input type="number" class="form-control product-quantity" onkeypress="handleQuantityKeyPress(event, this)"></td>
                        <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">Remove</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-primary" onclick="addRow(true)">Add New Product</button>
            <button type="button" class="btn btn-secondary" onclick="clearTable()">Clear</button>
        </div>
    </div>

    <!-- Add Cost Summary section after Product Details -->
    <div class="row mt-4">
        <div class="col-md-12">
            <h2>Cost Summary</h2>
            <table id="cost-summary-table" class="table">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Ordered Quantity</th>
                        <th>Unit Cost</th>
                        <th>Tax</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <div class="row justify-content-end">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="shipping-cost">Shipping Cost:</label>
                        <input type="number" id="shipping-cost" class="form-control" value="0.00" step="0.01" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label for="discounts">Discounts:</label>
                        <input type="number" id="discounts" class="form-control" value="0.00" step="0.01" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label for="other-adjustments">Other Adjustments:</label>
                        <input type="number" id="other-adjustments" class="form-control" value="0.00" step="0.01" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label for="total-amount">Total Amount:</label>
                        <input type="number" id="total-amount" class="form-control" value="0.00" readonly>
                    </div>
                </div>
            </div>
            
            <!-- Add action buttons -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-primary" onclick="saveAndSend()">Save and Send</button>
                        <button type="button" class="btn btn-secondary" onclick="saveAsDraft()">Save as Draft</button>
                        <button type="button" class="btn btn-danger" onclick="cancelPO()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const supplierSelect = document.getElementById('supplier-name');
    const storeSelect = document.getElementById('store-name');
    const myStoreCheckbox = document.getElementById('my-store');

    const suppliers = {
        {% for supplier in suppliers %}
        "{{ supplier.supplier_id }}": {
            address: "{{ supplier.address }}",
            city: "{{ supplier.city }}",
            region: "{{ supplier.region }}",
            phone_number: "{{ supplier.phone_number }}",
            payment_terms: "{{ supplier.payment_terms }}"
        },
        {% endfor %}
    };

    const stores = {
        {% for store in stores %}
        "{{ store.store_id }}": {
            address: "{{ store.address }}",
            city: "{{ store.city }}",
            region: "{{ store.region }}",
            phone_number: "{{ store.phone_number }}"
        },
        {% endfor %}
    };

    const myStore = {
        {% if my_store %}
        "{{ my_store.store_id }}": {
            address: "{{ my_store.address }}",
            city: "{{ my_store.city }}",
            region: "{{ my_store.region }}",
            phone_number: "{{ my_store.phone_number }}"
        }
        {% endif %}
    };

    // Auto-fill supplier details
    supplierSelect.addEventListener('change', function () {
        const supplier = suppliers[this.value];
        if (supplier) {
            document.getElementById('supplier-address').value = supplier.address;
            document.getElementById('supplier-city').value = supplier.city;
            document.getElementById('supplier-region').value = supplier.region;
            document.getElementById('supplier-phone').value = supplier.phone_number;
            document.getElementById('supplier-payment-terms').value = supplier.payment_terms;
        }
    });

    // Auto-fill store details
    storeSelect.addEventListener('change', function () {
        const store = stores[this.value];
        if (store) {
            document.getElementById('store-address').value = store.address;
            document.getElementById('store-city').value = store.city;
            document.getElementById('store-region').value = store.region;
            document.getElementById('store-phone').value = store.phone_number;
        }
    });

    // Auto-fill "My Store" details
    myStoreCheckbox.addEventListener('change', function () {
        if (this.checked && myStore) {
            const storeId = Object.keys(myStore)[0];
            const store = myStore[storeId];
            document.getElementById('store-name').value = storeId;
            document.getElementById('store-address').value = store.address;
            document.getElementById('store-city').value = store.city;
            document.getElementById('store-region').value = store.region;
            document.getElementById('store-phone').value = store.phone_number;
        } else {
            document.getElementById('store-name').value = '';
            document.getElementById('store-address').value = '';
            document.getElementById('store-city').value = '';
            document.getElementById('store-region').value = '';
            document.getElementById('store-phone').value = '';
        }
    });

    // Initialize "My Store" details if checked
    if (myStoreCheckbox.checked && myStore) {
        const storeId = Object.keys(myStore)[0];
        const store = myStore[storeId];
        document.getElementById('store-name').value = storeId;
        document.getElementById('store-address').value = store.address;
        document.getElementById('store-city').value = store.city;
        document.getElementById('store-region').value = store.region;
        document.getElementById('store-phone').value = store.phone_number;
    }

    // Check if draft data exists and restore it
    {% if draft_data %}
        const draftData = JSON.parse('{{ draft_data|escapejs|safe }}');
        console.log('Loaded draft data:', draftData);  // Debug log
        
        // Restore supplier details - first find and select the matching supplier
        const supplierSelect = document.getElementById('supplier-name');
        Array.from(supplierSelect.options).forEach(option => {
            if (option.text === draftData.supplier_name) {
                option.selected = true;
                // Trigger change event to load supplier products
                supplierSelect.dispatchEvent(new Event('change'));
            }
        });

        // Restore supplier details
        document.getElementById('supplier-address').value = draftData.supplier_address || '';
        document.getElementById('supplier-city').value = draftData.supplier_city || '';
        document.getElementById('supplier-region').value = draftData.supplier_region || '';
        document.getElementById('supplier-phone').value = draftData.supplier_phone || '';
        document.getElementById('supplier-payment-terms').value = draftData.supplier_payment_terms || '';

        // Restore store details - first find and select the matching store
        const storeSelect = document.getElementById('store-name');
        Array.from(storeSelect.options).forEach(option => {
            if (option.text === draftData.store_name) {
                option.selected = true;
                // Trigger change event
                storeSelect.dispatchEvent(new Event('change'));
            }
        });

        // Restore store details
        document.getElementById('store-address').value = draftData.store_address || '';
        document.getElementById('store-city').value = draftData.store_city || '';
        document.getElementById('store-region').value = draftData.store_region || '';
        document.getElementById('store-phone').value = draftData.store_phone || '';

        // Restore order details
        document.getElementById('reference-number').value = draftData.reference_number || '';
        document.getElementById('ordered-date').value = draftData.ordered_date || '';
        document.getElementById('expected-delivery-date').value = draftData.expected_delivery_date || '';
        document.getElementById('shipped-by').value = draftData.shipped_by || 'None';
        document.getElementById('shipment-preference').value = draftData.shipment_preference || 'None';
        document.getElementById('notes').value = draftData.notes || '';

        // Clear existing products
        clearTable();

        // Wait for supplier products to load before restoring product details
        setTimeout(() => {
            // Restore product details
            if (Array.isArray(draftData.product_details)) {
                draftData.product_details.forEach((product, index) => {
                    if (index > 0) addEmptyRow();
                    const rows = document.querySelectorAll('#product-table tbody tr');
                    const currentRow = rows[index];
                    
                    if (currentRow) {
                        const productSelect = currentRow.querySelector('.product-name');
                        Array.from(productSelect.options).forEach(option => {
                            if (option.text === product.name) {
                                option.selected = true;
                                productSelect.dispatchEvent(new Event('change'));
                            }
                        });
                        currentRow.querySelector('.product-quantity').value = product.quantity || '';
                    }
                });
            }

            // Restore cost summary
            if (Array.isArray(draftData.cost_summary)) {
                const costTable = document.getElementById('cost-summary-table').getElementsByTagName('tbody')[0];
                draftData.cost_summary.forEach(item => {
                    const newRow = costTable.insertRow();
                    newRow.innerHTML = `
                        <td>${item.product_name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit_cost}</td>
                        <td>${item.tax}</td>
                        <td>${item.subtotal}</td>
                    `;
                });
            }

            // Restore additional costs
            document.getElementById('shipping-cost').value = draftData.shipping_cost || 0;
            document.getElementById('discounts').value = draftData.discount || 0;
            document.getElementById('other-adjustments').value = draftData.other_adjustments || 0;
            document.getElementById('total-amount').value = draftData.total_amount || 0;

            // Update totals
            updateTotal();
        }, 500);  // Wait 500ms for supplier products to load
    {% endif %}
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const supplierSelect = document.getElementById('supplier-name');
        const productTable = document.getElementById('product-table');
    
        // Fetch products based on supplier selection
        supplierSelect.addEventListener('change', function () {
            const supplierId = this.value;
            if (supplierId) {
                fetch(`/purchase_order/get-supplier-products/${supplierId}/`)
                    .then(response => response.json())
                    .then(data => {
                        // Update all product dropdowns in the table
                        const productSelects = document.querySelectorAll('.product-name');
                        productSelects.forEach(productSelect => {
                            populateProductDropdown(productSelect, supplierId);
                        });
                    })
                    .catch(error => console.error('Error fetching products:', error));
            }
        });
    });
    
    // Update product details when a product is selected
    function updateProductDetails(select) {
        const row = select.closest('tr');
        const selectedOption = select.selectedOptions[0];
        
        if (selectedOption) {
            row.querySelector('.product-description').value = selectedOption.getAttribute('data-description') || '';
            row.querySelector('.product-uom').value = selectedOption.getAttribute('data-uom') || '';
            row.querySelector('.product-category').value = selectedOption.getAttribute('data-category') || '';
        } else {
            row.querySelector('.product-description').value = '';
            row.querySelector('.product-uom').value = '';
            row.querySelector('.product-category').value = '';
        }
    }
    
    // Add new row to the product table
    function addRow(addToSummary = false) {
        const lastRow = document.querySelector('#product-table tbody tr:last-child');
        
        // If addToSummary is true, process the last row before adding new one
        if (addToSummary) {
            const productSelect = lastRow.querySelector('.product-name');
            const quantityInput = lastRow.querySelector('.product-quantity');
            const quantity = parseInt(quantityInput.value);
    
            if (productSelect.value && quantity > 0) {
                const productName = productSelect.options[productSelect.selectedIndex].text;
                const costTable = document.getElementById('cost-summary-table').getElementsByTagName('tbody')[0];
                const existingRow = Array.from(costTable.rows).find(row => 
                    row.cells[0].textContent === productName
                );
    
                if (!existingRow) {
                    updateCostSummary(productSelect, quantity).then(() => {
                        // Add new empty row only after cost summary is updated
                        addEmptyRow();
                    });
                    return; // Exit early as new row will be added after cost summary update
                } else {
                    alert('This product is already added to the cost summary.');
                    return;
                }
            } else {
                alert('Please select a product and enter a valid quantity.');
                return;
            }
        }
    
        // If not adding to summary or validation failed, just add empty row
        addEmptyRow();
    }
    
    // Add new function for creating empty row
    function addEmptyRow() {
        const table = document.getElementById('product-table').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();
        const supplierId = document.getElementById('supplier-name').value;
        
        newRow.innerHTML = `
            <td>
                <select class="form-control product-name" onchange="updateProductDetails(this)">
                    <option value="">Select Product</option>
                </select>
            </td>
            <td><input type="text" class="form-control product-description" readonly></td>
            <td><input type="text" class="form-control product-uom" readonly></td>
            <td><input type="text" class="form-control product-category" readonly></td>
            <td><input type="number" class="form-control product-quantity" onkeypress="handleQuantityKeyPress(event, this)"></td>
            <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">Remove</button></td>
        `;
    
        if (supplierId) {
            populateProductDropdown(newRow.querySelector('.product-name'), supplierId);
        }
    }
    
    // Handle Enter key press in quantity field
    function handleQuantityKeyPress(event, input) {
        if (event.key === 'Enter') {
            event.preventDefault();
            handleProductAddition(input.closest('tr'));
        }
    }
    
    // Handle product addition
    function handleProductAddition(currentRow) {
        const productSelect = currentRow.querySelector('.product-name');
        const quantityInput = currentRow.querySelector('.product-quantity');
        const quantity = parseInt(quantityInput.value);
    
        if (productSelect.value && quantity > 0) {
            const productName = productSelect.options[productSelect.selectedIndex].text;
            const costTable = document.getElementById('cost-summary-table').getElementsByTagName('tbody')[0];
            const existingRow = Array.from(costTable.rows).find(row => 
                row.cells[0].textContent === productName
            );
    
            if (!existingRow) {
                // Add to cost summary first
                updateCostSummary(productSelect, quantity).then(() => {
                    // Add new row
                    addRow();
                });
            } else {
                alert('This product is already added to the cost summary.');
            }
        } else {
            alert('Please select a product and enter a valid quantity before adding a new product.');
        }
    }
    
    // Remove a row from the product table and the corresponding row in the cost summary
    function removeRow(button) {
        const row = button.closest('tr');
        if (row) {
            const productSelect = row.querySelector('.product-name');
            if (productSelect && productSelect.selectedIndex > 0) {
                // Get product name from the selected option
                const productName = productSelect.options[productSelect.selectedIndex].text;
                
                // Remove corresponding row from cost summary
                const costTable = document.getElementById('cost-summary-table').getElementsByTagName('tbody')[0];
                const costRow = Array.from(costTable.rows).find(row => 
                    row.cells[0].textContent === productName
                );
                
                if (costRow) {
                    costRow.remove();
                    updateTotal(); // Update total after removing cost row
                }
            }
    
            // If it's the first row, add a new empty row after removing it
            if (row.rowIndex === 0) {
                addRow();
            }
    
            row.remove();
        }
    }
    
    // Clear all rows except the first one
    function clearTable() {
        const table = document.getElementById('product-table').getElementsByTagName('tbody')[0];
        const costTable = document.getElementById('cost-summary-table').getElementsByTagName('tbody')[0];
        
        // Clear cost summary table
        while (costTable.firstChild) {
            costTable.removeChild(costTable.firstChild);
        }
        
        // Clear product table except first row
        while (table.children.length > 1) {
            table.removeChild(table.lastChild);
        }
        table.children[0].querySelectorAll('input').forEach(input => input.value = '');
        table.children[0].querySelector('select').selectedIndex = 0;
        
        updateTotal(); // Update total after clearing
    }
    
    // Populate product dropdown
    function populateProductDropdown(productSelect, supplierId) {
        fetch(`/purchase_order/get-supplier-products/${supplierId}/`)
            .then(response => response.json())
            .then(data => {
                productSelect.innerHTML = '<option value="">Select Product</option>';
                if (data.products) {
                    data.products.forEach(product => {
                        productSelect.insertAdjacentHTML('beforeend', `
                            <option value="${product.product_id}" 
                                    data-description="${product.product_description || ''}"
                                    data-uom="${product.uom || ''}"
                                    data-category="${product.category_name || ''}">
                                ${product.product_name}
                            </option>
                        `);
                    });
                }
            })
            .catch(error => console.error('Error fetching products:', error));
    }
    
    // Update cost summary
    function updateCostSummary(productSelect, quantity) {
        return new Promise((resolve, reject) => {
            const supplierId = document.getElementById('supplier-name').value;
            const productId = productSelect.value;
            const productName = productSelect.options[productSelect.selectedIndex].text;
    
            fetch(`/purchase_order/get-product-costs/${productId}/${supplierId}/`)
                .then(response => {
                    if (!response.ok) throw new Error('Product cost data not found');
                    return response.json();
                })
                .then(data => {
                    const costTable = document.getElementById('cost-summary-table').getElementsByTagName('tbody')[0];
                    const unitCost = parseFloat(data.unit_cost) || 0;
                    const tax = parseFloat(data.tax) || 0;
                    const subtotal = (quantity * unitCost) + tax;
    
                    if (!isNaN(unitCost) && !isNaN(tax) && !isNaN(subtotal)) {
                        const newRow = costTable.insertRow();
                        newRow.innerHTML = `
                            <td>${productName}</td>
                            <td>${quantity}</td>
                            <td>${unitCost.toFixed(2)}</td>
                            <td>${tax.toFixed(2)}</td>
                            <td>${subtotal.toFixed(2)}</td>
                        `;
                        updateTotal();
                        resolve();
                    } else {
                        reject('Invalid cost values received');
                    }
                })
                .catch(reject);
        });
    }
    
    // Update total amount
    function updateTotal() {
        const costRows = document.querySelectorAll('#cost-summary-table tbody tr');
        let subtotal = 0;
    
        // Calculate subtotal from all product rows
        costRows.forEach(row => {
            subtotal += parseFloat(row.cells[4].textContent);
        });
    
        // Get additional costs
        const shippingCost = parseFloat(document.getElementById('shipping-cost').value) || 0;
        const discounts = parseFloat(document.getElementById('discounts').value) || 0;
        const otherAdjustments = parseFloat(document.getElementById('other-adjustments').value) || 0;
    
        // Calculate total
        const total = subtotal + shippingCost - discounts + otherAdjustments;
        document.getElementById('total-amount').value = total.toFixed(2);
    }
    
    // Handle "Add New Product" button click
    function handleAddNewProductButtonClick() {
        const lastRow = document.querySelector('#product-table tbody tr:last-child');
        handleProductAddition(lastRow);
    }

    // Add these new functions for the buttons
    function saveAndSend() {
        // Validate required fields
        if (!validateForm()) {
            return;
        }

        // Gather data from the form
        const poData = {
            po_number: document.getElementById('po-number').value,
            supplier_id: document.getElementById('supplier-name').value,
            order_date: document.getElementById('ordered-date').value,
            expected_delivery_date: document.getElementById('expected-delivery-date').value,
            total_order_value: parseFloat(document.getElementById('total-amount').value),
            notes: document.getElementById('notes').value,
            products: []
        };

        // Gather products data
        const costRows = document.querySelectorAll('#cost-summary-table tbody tr');
        costRows.forEach(row => {
            const productName = row.cells[0].textContent;
            const productId = getProductIdByName(productName);
            
            if (!productId) {
                throw new Error(`Could not find product ID for ${productName}`);
            }

            poData.products.push({
                product_id: productId,  // This should now be properly populated
                product_name: productName,
                quantity: parseInt(row.cells[1].textContent),
                unit_cost: parseFloat(row.cells[2].textContent),
                tax: parseFloat(row.cells[3].textContent),
                subtotal: parseFloat(row.cells[4].textContent),
                uom: getProductUOMByName(productName)
            });
        });

        // Send data to server
        fetch('/purchase_order/save-purchase-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(poData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Purchase Order created successfully!');
                window.location.href = '{% url "purchase_order_list" %}';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error saving purchase order: ' + error);
        });
    }

    function validateForm() {
        const requiredFields = {
            'supplier-name': 'Supplier',
            'ordered-date': 'Order Date',
            'expected-delivery-date': 'Expected Delivery Date'
        };

        for (const [id, label] of Object.entries(requiredFields)) {
            const field = document.getElementById(id);
            if (!field.value) {
                alert(`${label} is required`);
                field.focus();
                return false;
            }
        }

        const costRows = document.querySelectorAll('#cost-summary-table tbody tr');
        if (costRows.length === 0) {
            alert('Please add at least one product');
            return false;
        }

        return true;
    }

    // Helper functions to get product details
    function getProductIdByName(productName) {
        const productSelect = Array.from(document.querySelectorAll('.product-name')).find(select => 
            select.options[select.selectedIndex]?.text === productName
        );
        return productSelect ? productSelect.value : null;
    }

    function getProductUOMByName(productName) {
        const row = Array.from(document.querySelectorAll('.product-name')).find(select => 
            select.options[select.selectedIndex]?.text === productName
        )?.closest('tr');
        return row ? row.querySelector('.product-uom').value : null;
    }

    function saveAsDraft() {
        // Gather all form data
        const draftData = {
            // Supplier details
            supplier_name: document.querySelector('#supplier-name option:checked')?.text || '',
            supplier_address: document.getElementById('supplier-address').value,
            supplier_city: document.getElementById('supplier-city').value,
            supplier_region: document.getElementById('supplier-region').value,
            supplier_phone: document.getElementById('supplier-phone').value,
            supplier_payment_terms: document.getElementById('supplier-payment-terms').value,

            // Store details
            store_name: document.querySelector('#store-name option:checked')?.text || '',
            store_address: document.getElementById('store-address').value,
            store_city: document.getElementById('store-city').value,
            store_region: document.getElementById('store-region').value,
            store_phone: document.getElementById('store-phone').value,

            // Order details
            reference_number: document.getElementById('reference-number').value || null,
            ordered_date: document.getElementById('ordered-date').value || null,
            expected_delivery_date: document.getElementById('expected-delivery-date').value || null,
            shipped_by: document.getElementById('shipped-by').value,
            shippment_preference: document.getElementById('shipment-preference').value,
            notes: document.getElementById('notes').value,

            // Product details as JSON
            product_details: Array.from(document.querySelectorAll('#product-table tbody tr')).map(row => ({
                name: row.querySelector('.product-name option:checked')?.text || '',
                description: row.querySelector('.product-description').value,
                uom: row.querySelector('.product-uom').value,
                category: row.querySelector('.product-category').value,
                quantity: row.querySelector('.product-quantity').value
            })),

            // Cost summary as JSON
            cost_summary: Array.from(document.querySelectorAll('#cost-summary-table tbody tr')).map(row => ({
                product_name: row.cells[0].textContent,
                quantity: row.cells[1].textContent,
                unit_cost: row.cells[2].textContent,
                tax: row.cells[3].textContent,
                subtotal: row.cells[4].textContent
            })),

            // Additional costs
            shipping_cost: parseFloat(document.getElementById('shipping-cost').value) || 0,
            discount: parseFloat(document.getElementById('discounts').value) || 0,
            other_adjustments: parseFloat(document.getElementById('other-adjustments').value) || 0,
            total_amount: parseFloat(document.getElementById('total-amount').value) || 0
        };

        // Send data to server
        fetch('/purchase_order/save-draft/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(draftData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Draft saved successfully!');
                window.location.href = '{% url "purchase_order_list" %}';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error saving draft: ' + error);
        });
    }

    function cancelPO() {
        if (confirm('Are you sure you want to cancel? All unsaved changes will be lost.')) {
            window.location.href = '{% url "purchase_order_list" %}';
        }
    }
</script>
{% endblock %}